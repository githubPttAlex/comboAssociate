<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Charlas técnicas - wedoIT - Herramientas Productividad">
        <meta name="author" content="Charlas técnicas - wedoIT - Herramientas Productividad">
        <title>Charlas técnicas - wedoIT - Herramientas Productividad</title>
        <!-- Bootstrap core CSS -->
        <link href="../resources/bootstrap-4.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="../resources/bootstrap-4.0.0/docs/4.0/examples/album/album.css" rel="stylesheet">
        <link href="../resources/css/font-awesome.min.css" rel="stylesheet">
        <style>
            .bg-dark {background-color: #074c90 !important}
            .navbar-dark .navbar-brand {color: #90e61f;}
            .h4, h4 {font-size: 20px;}
            .alert-primary {
                color: #90e61f;
                background-color: #074c90 !important;
                border-color: #074c90 !important;
            }
            .list-group-item.active {
                z-index: 2;
                color: #6d6161;
                background-color: #dee2e6;
                border-color: #dee2e6;
                font-weight: 700;
            }
            .syntax{    
                background: #F0F0F0;
                padding: 32px;
            }
            .font16{font-size: 16px;}
            div#fillDivActions{margin-top: 10px;}
            a{color: #2f9023;}
            .text-muted {color: #90e61f !important;background-color: #074c90;}
            footer p {margin-bottom: .25rem;font-weight: bold;}
            p { margin-top: 0;}
            @media print {
                .col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12 {
                  float: left;
                }
                .col-sm-12 {
                  width: 100%;
                }
                .col-sm-11 {
                  width: 91.66666666666666%;
                }
                .col-sm-10 {
                  width: 83.33333333333334%;
                }
                .col-sm-9 {
                  width: 75%;
                }
                .col-sm-8 {
                  width: 66.66666666666666%;
                }
                .col-sm-7 {
                  width: 58.333333333333336%;
                }
                .col-sm-6 {
                  width: 50%;
                }
                .col-sm-5 {
                  width: 41.66666666666667%;
                }
                .col-sm-4 {
                  width: 33.33333333333333%;
                 }
                 .col-sm-3 {
                   width: 25%;
                 }
                 .col-sm-2 {
                   width: 16.666666666666664%;
                 }
                 .col-sm-1 {
                  width: 8.333333333333332%;
                 }
                 .fa-arrow-circle-up{display: none;}
            }
        </style>
    </head>
    <body>
        <header>
            <div class="navbar navbar-dark bg-dark box-shadow">
                  <div class="container d-flex justify-content-between">
                    <a href="#" class="navbar-brand d-flex align-items-center">
                        <strong>Charlas técnicas - wedoIT - Herramientas Productividad</strong>
                    </a>
                  </div>
            </div>
        </header>
        <main role="main">
          <section class="jumbotron text-center" style="padding-top: 33px;padding-bottom: 2px;">
                <div class="container">
                  <h1 class="jumbotron-heading">Ejemplo sistema notificaciones - GPI</h1> 
                </div>
          </section>
        </main>
           
        <div class="container-fluid"> 
            <div class="row content">
  
                <div class="col-sm-6">
                    <div class="tab-content" id="nav-tabContent">
                        <hr>
                        <div class="tab-pane fade show active" id="list-home" role="tabpanel" aria-labelledby="list-home-list">

                            <div class="alert alert-primary grey" role="alert">
                               <h4> <i class="fa fa-paperclip" aria-hidden="true"></i> ROUTES</h4>
                            </div>

                            <p>Para la aplicación GPI desarrollamos basándonos en <strong>Laravel</strong>, por lo tanto contamos con un almacén de rutas disponibles para la aplicación.
                             A continuación mostramos un ejemplo de <strong>"Route"</strong> en Laravel/GPI:</p>

                            <pre>
                                <code class="js hljs">  	
        Route::delete('deletePE',[
            'middleware' => 'manage_roles',
            'functionality' => 'deleteDeliveryPlan',
            'url_error' => 'accesodenegado',
            'applicationName' => 'PDI',
            'uses' => 'PDI\solinfraController@deletePE'
        ]); 
                                </code>
                            </pre>

                        </div>  
                    </div>
                </div>
                
                
            <div class="col-sm-6">
                <div class="tab-content" id="nav-tabContent">
                    <hr>
                    <div class="tab-pane fade show active" id="list-home" role="tabpanel" aria-labelledby="list-home-list">
                        <div class="alert alert-primary grey" role="alert">
                           <h4> <i class="fa fa-paperclip" aria-hidden="true"></i> JS EN BLADE.PHP</h4>
                        </div>
                        <p>Todo empieza con un botón, en este caso. Establecemos con <strong>jQuery</strong> el funcionamiento del botón:</p>
                        <br>
                        <p>
                            a) Realizar llamada <strong>AJAX</strong> al controlador <strong>PHP</strong>, usando la <strong>"Route"</strong> que vimos anteriormente.
                            <br>
                            b) Recoger la respuesta y actuar en consecuencia, es decir: lanzar la notificación si todo ha ido bien, o mostrar un mensaje de error para el usuario.
                            <br>
                            b) Recoger la respuesta de la notificación enviada, o mostrar un mensaje de error de notificación para el usuario.
                        </p>
                        <pre>
                            <code class="js hljs">  	
    $(".deleteDeliveryPlan").click(function () {
        
        
        var idPE = $(this).attr('idPE');
        var idSolinfra = $(this).attr('idSolinfra');
        
        var op = {};
        op.onHidden = function () {
            location.reload();
        };
        
        var opModal = {};
        opModal.ok = function () {
            $.ajax({
                type: "delete",
                url: "{{URL::to('deletePE')}}",
                data: {
                    deliveryPlanId: idPE,
                    solinfraId: idSolinfra,
                    _token: "{{ csrf_token() }}"
                },
                dataType: "json",
                success: function (response) {
                    if (response.success) {
                        var opNotif = {};
                        opNotif.onHidden = function () {
                            var idNotif = response.notificationId;
                            notifyWS(idNotif);
                        };
                        toastr.success(response.message, null, opNotif);
                    }else{
                        toastr.error(response.message, null, op);
                    }
                }
            });
        };
        opModal.cancel = function () {
            window.location.reload();
        };
        toastr.warning_modal("Está seguro que desea eliminar el Plan de Entrega", "¿Borrar el Plan de Entrega?", opModal);
    });
                            </code>
                        </pre>
                       
                        <p>Función <strong>JS</strong> que enviará la notificación:</p>
                        <pre>
                            <code class="js hljs">  	             
    function notifyWS(idNotif) {
        var opModal = {};
        opModal.ok = function () {

            var op = {};
            op.onHidden = function () {
                window.location.reload();
            };

            var dataAjax = {};
            dataAjax.notificationId = idNotif;
            dataAjax._token = "{{csrf_token()}}";
 
            var optionsAjax = {
                url: "{{URL::to('notifications')}}",
                type: "POST",
                data: dataAjax,
                dataType: "json",
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message, null, op);
                    }else{ 
                        toastr.error(response.message, null, op);
                    }
                }
            };
            ajaxCall(optionsAjax);
        };
        opModal.cancel = function () {
            window.location.reload();
        };
        toastr.warning_modal("Desea notificar la acción ahora o más adelante", "¿Notificar acción?", opModal);
    }
                            </code>
                        </pre>
                    </div> 
                </div>
            </div>
          
   
            <div class="col-sm-12">   
                <div class="tab-content" id="nav-tabContent">
                    <hr>
                    
                    <div class="tab-pane fade show active" id="list-home" role="tabpanel" aria-labelledby="list-home-list">    
                        <div class="alert alert-primary grey" role="alert">
                           <h4> <i class="fa fa-paperclip" aria-hidden="true"></i> CONTROLADOR PHP</h4>
                        </div>
                    
                        <p>A continuación mostramos la parte más importante de esta función <strong>PHP</strong> (la invocamos/llamamos desde <strong>JS</strong>). El cometido de esta función será realizar 
                        la operación que se requiera (en este caso se llevaría a cabo el borrado lógico de un "Plan de Entrega") y además devolver una respuesta (que pueda ser interpretada por la funcion <strong>JS</strong> que realizó esa llamada).</p>
                    
                        <pre>
                            <code class="php hljs">  	
    /**
    * Eliminar un Plan de Entrega.
    * Se recibe el ID del PE a borrar
    */
    public function deletePE() {
        .......
        
        $arrData2= array(
            array(1,$solinfraID,PDO::PARAM_INT),
            array(2,$deliveryPlanID,PDO::PARAM_INT),
            array(3,$userId,PDO::PARAM_INT),
            array(4,&$hist_call_ws,PDO::PARAM_INT|PDO::PARAM_INPUT_OUTPUT),
            array(5,&$message,PDO::PARAM_STR|PDO::PARAM_INPUT_OUTPUT, 1000)
        );
        $resp = DB::loadProcedure('CALL PDI.P15_REMOVE_DELIVERY_PLAN(?,?,?,?,?)', $arrData2);
        if( $resp && empty($message)){
            $message = 'PE Eliminado correctamente';
            $success = true;
        }else{
            $message = 'Ocurrio un errror interno';
            $success = false;
        }
        print_r(json_encode(["success" => $success,"message" => $message, "notificationId" => $hist_call_ws]));
    }
                            </code>
                        </pre>

                        <p>
                            Tenemos un controlador <strong>PHP</strong> que maneja estas llamadas con <strong>CURL</strong>. La función principal se llama <strong>notificationsById</strong>:
                        </p>
     
                        <pre>
                            <code class="php hljs">                    
    public function notificationsById($notificationID){     
        if(empty($notificationID)){
            return json_encode(array("success" => false, "message" => "ERROR: Código de notificación no enviado"));
        }                    
        $notificationDetail = self::getDetailNotification($notificationID);
        return json_encode(self::sendCurl($notificationID,$notificationDetail));  
    }  
                            </code>
                        </pre>
                        <p>
                            A continuación mostramos un ejemplo del <strong>CURL</strong> que se llevaría a cabo.
                        </p>
  
                        <pre>
                            <code class="js hljs">  	
    curl -H "Content-Type: application/json" -X POST -d '{  
        "issue":{  
            "key":"SOLINFRA-29XX"
        },
        "usuario":{  
            "name":"Usuario Responsable WPM"
        }
    }' http://URL_JIRA_DES/rest/operaciones/borrarissue
                            </code>
                        </pre>

                    </div>
                </div>
            </div>
  
            <div class="col-sm-12">     
                <div class="tab-content" id="nav-tabContent">
                    <hr>
                    <div class="tab-pane fade show active" id="list-home" role="tabpanel" aria-labelledby="list-home-list">
                        
                        <div class="alert alert-primary grey" role="alert">
                           <h4> <i class="fa fa-paperclip" aria-hidden="true"></i> JSON (INPUT + OUTPUT)</h4>
                        </div>
                        <p>Ejemplo del <strong>JSON</strong> enviado:</p> 
                        <pre>
                            <code class="json hljs">  	
    {  
        "issue":{  
            "key":"SOLINFRA-29XX"
        },
        "usuario":{  
            "name":"Usuario Responsable WPM"
        }
     }
                            </code>
                        </pre>
                        
                        <p>Ejemplo del <strong>JSON</strong> recibido:</p>
                        <pre>
                            <code class="json hljs">  	
    {
        "result":"OK",
        "message":"Issue deleted"
    }
                            </code>
                        </pre>
                         
                         
                        <p>Ejemplo de posibles respuestas:</p>
                       <pre>
                            <code class="json hljs">  	     
    {"result": "ERROR", "message": "No existe ninguna issue con la clave "}             
    {"result": "ERROR", "message": "Invalid JSON"}  
                            </code>
                        </pre>
   
                    </div>  
                </div>
            </div>  
        </div>
        </div>
        <br/><footer class="text-muted">
          <div class="container">
                <p class="float-right">
                  <a href="#"><i style="color: #90e61f;font-size: 60px;" class="fa fa-arrow-circle-up fa-4" aria-hidden="true"></i></a>
                </p>
                <p style="font-size: 21px;">Charlas técnicas - wedoIT - Herramientas Productividad</p>
          </div>
        </footer>
        <!-- Bootstrap core JavaScript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="../resources/js/jquery-3.3.1.min.js"></script>
        <script>window.jQuery || document.write('<script src="../resources/bootstrap-4.0.0/assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
        <script src="../resources/bootstrap-4.0.0/assets/js/vendor/popper.min.js"></script>
        <script src="../resources/bootstrap-4.0.0/dist/js/bootstrap.min.js"></script>
        <script src="../resources/bootstrap-4.0.0/assets/js/vendor/holder.min.js"></script>
        <link rel="stylesheet" href="../resources/higlight-js/default.css" />
        <script src="../resources/higlight-js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>